# TrendPublish 系统架构文档

## 1. 架构概览

### 1.1 整体架构
TrendPublish 采用模块化的微服务架构设计，基于 Deno 运行时构建，具有高度的可扩展性和可维护性。

```
┌─────────────────────────────────────────────────────────────┐
│                    TrendPublish 系统架构                      │
├─────────────────────────────────────────────────────────────┤
│  应用层 (Application Layer)                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   定时任务   │  │  JSON-RPC   │  │   Web界面   │         │
│  │   调度器     │  │    API      │  │   (可选)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  工作流层 (Workflow Layer)                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  微信文章    │  │  AI Bench   │  │ HelloGitHub │         │
│  │  工作流      │  │   工作流     │  │   工作流     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  服务层 (Service Layer)                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  内容抓取    │  │  内容处理    │  │  内容发布    │         │
│  │   服务      │  │   服务      │  │   服务      │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  模块层 (Module Layer)                                       │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐   │
│  │抓取器│ │排序器│ │摘要器│ │发布器│ │渲染器│ │通知器│   │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘   │
├─────────────────────────────────────────────────────────────┤
│  提供者层 (Provider Layer)                                   │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐   │
│  │ LLM  │ │图片生│ │向量化│ │重排序│ │数据源│ │配置  │   │
│  │提供者│ │成器  │ │模型  │ │模型  │ │适配器│ │管理器│   │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘   │
├─────────────────────────────────────────────────────────────┤
│  数据层 (Data Layer)                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   MySQL     │  │   向量数据   │  │   文件存储   │         │
│  │   数据库     │  │     库      │  │   (模板等)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术栈
- **运行时**：Deno 2.0+
- **开发语言**：TypeScript
- **数据库**：MySQL (Drizzle ORM)
- **AI 服务**：DeepSeek, 通义千问, 讯飞星火, OpenAI, Jina AI
- **模板引擎**：EJS
- **任务调度**：node-cron
- **HTTP 客户端**：Deno 原生 fetch

## 2. 核心组件架构

### 2.1 工作流引擎 (Workflow Engine)

#### 2.1.1 工作流基类
```typescript
abstract class WorkflowEntrypoint<TEnv, TParams> {
  protected env: WorkflowEnv<TEnv>;
  protected metricsCollector: MetricsCollector;
  
  abstract run(event: WorkflowEvent<TParams>, step: WorkflowStep): Promise<void>;
}
```

#### 2.1.2 工作流步骤
- **重试机制**：支持指数退避和线性重试
- **超时控制**：可配置步骤执行超时时间
- **错误处理**：区分可重试错误和终止错误
- **指标收集**：记录执行时间、重试次数等指标

#### 2.1.3 工作流类型
1. **WeixinArticleWorkflow**：综合内容工作流
2. **WeixinAIBenchWorkflow**：AI 模型排行榜工作流
3. **WeixinHelloGithubWorkflow**：开源项目推荐工作流

### 2.2 内容抓取架构

#### 2.2.1 抓取器接口
```typescript
interface ContentScraper {
  scrape(sourceId: string, options?: ScraperOptions): Promise<ScrapedContent[]>;
}
```

#### 2.2.2 抓取器实现
- **FireCrawlScraper**：网页内容抓取
- **TwitterScraper**：Twitter/X 内容抓取
- **HelloGithubScraper**：GitHub 热门项目抓取
- **RSSHubScraper**：RSS 内容聚合抓取

#### 2.2.3 数据源管理
- 支持数据库动态配置
- 本地配置文件备份
- 多平台数据源统一管理

### 2.3 AI 服务架构

#### 2.3.1 LLM 提供者工厂
```typescript
class LLMFactory {
  getProvider(config: LLMConfig): LLMProvider;
}
```

#### 2.3.2 支持的 AI 服务
- **DeepSeek AI**：主要用于内容摘要和排序
- **通义千问**：备用 LLM 服务
- **讯飞星火**：多模态内容处理
- **OpenAI**：标准 API 兼容
- **Jina AI**：搜索、嵌入和重排序

#### 2.3.3 向量化服务
- **文本嵌入**：支持多种嵌入模型
- **相似度计算**：余弦相似度算法
- **去重机制**：基于向量相似度的内容去重

### 2.4 发布系统架构

#### 2.4.1 发布器接口
```typescript
interface ContentPublisher {
  uploadImage(imageUrl: string): Promise<string>;
  publish(article: string, ...args: any[]): Promise<PublishResult>;
}
```

#### 2.4.2 微信公众号发布
- **访问令牌管理**：自动刷新和缓存
- **图片上传**：支持网络图片上传到微信服务器
- **IP 白名单验证**：发布前验证服务器 IP
- **草稿管理**：支持草稿创建和发布

#### 2.4.3 模板渲染系统
- **EJS 模板引擎**：动态内容渲染
- **多模板支持**：default, modern, tech, mianpro 等
- **随机模板**：支持随机选择模板样式

## 3. 数据流架构

### 3.1 数据流向图
```
数据源 → 抓取器 → 内容处理 → 排序筛选 → 模板渲染 → 发布平台
  ↓        ↓        ↓        ↓        ↓        ↓
配置管理  错误处理  AI处理   去重机制  图片生成  通知推送
```

### 3.2 数据处理流程

#### 3.2.1 内容抓取阶段
1. 从配置中获取数据源列表
2. 并行执行多个抓取器
3. 收集所有抓取结果
4. 统计抓取成功/失败数量

#### 3.2.2 内容处理阶段
1. AI 内容摘要和优化
2. 关键词提取
3. 向量化处理（如启用去重）
4. 相似度计算和去重

#### 3.2.3 内容排序阶段
1. AI 内容质量评分
2. 按评分排序
3. 选择 Top N 篇文章
4. 补充元数据信息

#### 3.2.4 内容发布阶段
1. 生成文章标题
2. 创建封面图片
3. 渲染文章模板
4. 发布到目标平台

## 4. 安全架构

### 4.1 API 密钥管理
- 环境变量存储
- 运行时动态加载
- 敏感信息不记录日志

### 4.2 访问控制
- IP 白名单验证
- API 访问令牌管理
- 请求频率限制

### 4.3 错误处理
- 分级错误处理机制
- 敏感信息脱敏
- 详细错误日志记录

## 5. 监控和运维架构

### 5.1 指标收集
- 工作流执行指标
- 步骤执行时间统计
- 成功/失败率统计
- 重试次数统计

### 5.2 日志系统
- 结构化日志输出
- 多级别日志记录
- 关键操作审计日志

### 5.3 通知系统
- 多渠道通知支持
- 任务状态实时推送
- 错误告警机制

## 6. 扩展性设计

### 6.1 插件化架构
- 抓取器插件化
- AI 服务提供者插件化
- 发布平台插件化
- 通知渠道插件化

### 6.2 配置驱动
- 数据源动态配置
- 工作流参数配置
- 模板动态选择
- AI 服务动态切换

### 6.3 容器化支持
- Docker 镜像构建
- 环境变量配置
- 数据持久化
- 服务编排支持